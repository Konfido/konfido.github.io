<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="What &amp; Why?  The other day, while I was wondering and searching if it&#39;s possible to convert research papers (PDF file) into audiobooks, which then could be well utilized on my way to the Lab or ca">
<meta property="og:type" content="article">
<meta property="og:title" content="PDF2Audio - Convert PDFs to Audiobooks with Machine Learning">
<meta property="og:url" content="https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/index.html">
<meta property="og:site_name" content="Konfido&#39;s Blog">
<meta property="og:description" content="What &amp; Why?  The other day, while I was wondering and searching if it&#39;s possible to convert research papers (PDF file) into audiobooks, which then could be well utilized on my way to the Lab or ca">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://konfido.github.io/images/20210430113414677.png">
<meta property="og:image" content="https://konfido.github.io/images/20210508171525893.png">
<meta property="article:published_time" content="2021-04-15T01:51:56.000Z">
<meta property="article:modified_time" content="2021-05-17T19:04:07.000Z">
<meta property="article:author" content="Konfido">
<meta property="article:tag" content="project">
<meta property="article:tag" content="ML">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://konfido.github.io/images/20210430113414677.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>PDF2Audio - Convert PDFs to Audiobooks with Machine Learning</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Konfido's Blog" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" "Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post " href="/Request-to-Cloud-Storage-API-in-Apps-Script-with-OAuth2/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post " href="/Use-NTFS-hard-drive-to-create-Mac-TimeMachine/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top " href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&text=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&title=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&is_video=false&description=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning&body=Check out this article: https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&title=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&title=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&title=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&title=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&name=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&t=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#what-why"><span class="toc-number">1.</span> <span class="toc-text">What &amp; Why?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#what-google-servicesapis-are-we-gonna-use"><span class="toc-number">2.</span> <span class="toc-text">What Google services&#x2F;APIs are we gonna use?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#what-can-we-finally-achieve"><span class="toc-number">3.</span> <span class="toc-text">What can we finally achieve?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#how-to-evaluate-the-final-result"><span class="toc-number">4.</span> <span class="toc-text">How to evaluate the final result?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-by-step-guide"><span class="toc-number">5.</span> <span class="toc-text">Step-by-step guide</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#create-a-google-cloud-project"><span class="toc-number">5.1.</span> <span class="toc-text">1. Create a Google Cloud project</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#create-a-bucket"><span class="toc-number">5.2.</span> <span class="toc-text">2. Create a Bucket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#create-a-cloud-funtion"><span class="toc-number">5.3.</span> <span class="toc-text">3. Create a Cloud Funtion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#create-an-apps-script-project"><span class="toc-number">5.4.</span> <span class="toc-text">4. Create an Apps Script project</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#create-a-spread-sheet"><span class="toc-number">5.5.</span> <span class="toc-text">5. Create a Spread Sheet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#label-the-training-dataset"><span class="toc-number">5.6.</span> <span class="toc-text">6. Label the training dataset</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#create-an-automl-table"><span class="toc-number">5.7.</span> <span class="toc-text">7. Create an AutoML Table</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#select-an-audio-voice"><span class="toc-number">5.8.</span> <span class="toc-text">8. Select an audio voice</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#edit-the-cloud-function"><span class="toc-number">5.9.</span> <span class="toc-text">9. Edit the Cloud Function</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#generate-the-audio"><span class="toc-number">5.10.</span> <span class="toc-text">10. Generate the audio</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#deploy-and-debug-with-command-line"><span class="toc-number">6.</span> <span class="toc-text">Deploy and Debug with command line</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#references"><span class="toc-number">7.</span> <span class="toc-text">References</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        PDF2Audio - Convert PDFs to Audiobooks with Machine Learning
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Konfido</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-04-15T01:51:56.000Z" itemprop="datePublished">2021-04-15</time>
        
        (Updated: <time datetime="2021-05-17T19:04:07.000Z" itemprop="dateModified">2021-05-18</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/ML/" rel="tag">ML</a>, <a class="tag-link-link" href="/tags/project/" rel="tag">project</a>
    </div>


      
    <span id="/Convert-PDFs-to-Audiobooks-with-Machine-Learning/" class="leancloud_visitors">
        <span class="meta-seperator">|</span>
        <i class="fa fa-eye"></i>
        <i class="leancloud-visitors-count"></i>
    </span>

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="what-why">What &amp; Why?</h2>
<ul>
<li><p>The other day, while I was wondering and searching if it's possible to convert research papers (PDF file) into audiobooks, which then could be well utilized on my way to the Lab or canteen, the following two articles caught my attention.</p>
<ul>
<li>Dale Markowitz: <a target="_blank" rel="noopener" href="https://daleonai.com/pdf-to-audiobook">Convert PDFs to Audiobooks with Machine Learning</a></li>
<li>佐藤一憲 Kazunori Sato：<a target="_blank" rel="noopener" href="https://cloud.google.com/blog/ja/products/ai-machine-learning/practical-machine-learning-with-automl-series-3">〜AutoMLで実践する〜 ビジネスユーザーのための機械学習入門シリーズ 【第 3 回】 「積ん読」と「体重増」の悩みを AutoML で解決しよう</a></li>
</ul></li>
<li><p>Here is an example clip of the generated audio:</p>
<p><audio style="height: 40px;" src="../images/20210518030009000.mp3" controls="" preload="metadata"></audio></p></li>
<li><p>The main converting process (from <a target="_blank" rel="noopener" href="https://cloud.google.com/blog/ja/products/ai-machine-learning/practical-machine-learning-with-automl-series-3">Kazunori</a>)</p>
<p><img src="../images/20210430113414677.png" width=90%/></p></li>
<li><p>The <a target="_blank" rel="noopener" href="https://cloud.google.com/blog/ja/products/ai-machine-learning/practical-machine-learning-with-automl-series-3">article</a> and <a target="_blank" rel="noopener" href="https://github.com/kazunori279/pdf2audiobook">code</a> of Kazunori Sato are great and helped me a lot in understanding the general method and process, but they unfortunately didn't provide much information on what exactly procedures I should perform on each step. After working on it for a few days, I managed to accomplish this project and archive my initial purpose. I wrote this blog as a guide to elaborate the required operations, hoping it could help you well.</p></li>
<li><p>And check out my code on <a target="_blank" rel="noopener" href="https://github.com/Konfido/pdf2audiobook">GitHub</a>.</p></li>
</ul>
<h2 id="what-google-servicesapis-are-we-gonna-use">What Google services/APIs are we gonna use?</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://console.cloud.google.com/storage/browser">Cloud Storage</a>: We will create a bucket to retain uploaded PDF and generated MP3 files.</li>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/functions">Cloud Functions</a>: Function-as-a-Service, used to describe the whole procedures.</li>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/vision">Vision API</a>: Cloud OCR which extract features (text, positions, size ...) of PDF</li>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/automl">AutoML Tables</a>：Layout classification (detect and delete unnecessary strings)</li>
<li><a target="_blank" rel="noopener" href="https://cloud.google.com/text-to-speech">Text to Speech</a>: Speech synthesis</li>
<li><a target="_blank" rel="noopener" href="https://developers.google.com/apps-script">Apps Script</a>：Annotation tool, easing the process of labelling dataset.</li>
</ul>
<h2 id="what-can-we-finally-achieve">What can we finally achieve?</h2>
<ul>
<li><p>Once we upload a PDF file to the bucket, all functions will be triggered sequentially and a MP3 file will be generated in the end.</p></li>
<li><p>We can also preset different voices for header, caption and the body of a paper, determining their accent, speed and pitch. And all parts will be naturally synthesized and merged together.</p></li>
</ul>
<h2 id="how-to-evaluate-the-final-result">How to evaluate the final result?</h2>
<ul>
<li><p>It's awesome to see that AI can actually help in my routine life.</p></li>
<li><p>But the Google Vision API definitely has room for improvement. Specifically, the most significant problem is the usability for two-column papers. It only performs well for single-column ones, relatively.</p></li>
<li><p>And I overlooked a big issue that there are a lot of formulas in the papers. It usually take me a long time to understand them, let alone just hear some jumbled characters and symbols of them. So I lowered my expectations, only sought to understand general idea of the paper. And it works.</p></li>
</ul>
<h2 id="step-by-step-guide">Step-by-step guide</h2>
<h3 id="create-a-google-cloud-project">1. Create a Google Cloud project</h3>
<ul>
<li><p>Create a new project in <a target="_blank" rel="noopener" href="https://console.cloud.google.com/">Cloud Platform console</a></p></li>
<li><p>Enable billing</p></li>
<li><p>Enable all APIs we intend to use!!</p>
<ul>
<li>Go to <a target="_blank" rel="noopener" href="https://console.cloud.google.com/apis/dashboard">API and Services</a></li>
<li>"Dashboard"
<ul>
<li>Click <code>+ Enable APIS AND SERVICES</code></li>
<li>Enable: Cloud Function API, Vision API, Cloud Build API, AutoML Tables, App Script API, Text-to-Speech API</li>
</ul></li>
<li>"OAuth consent screen"
<ul>
<li>User Type: Make External</li>
<li>Scope: https://cloud.googleapis.com/auth/devstorage.read_write</li>
<li>Test User: your google email</li>
</ul></li>
<li>"Credentials": Prepare authorization for App Script to access Cloud Storage
<ul>
<li>Click <code>Create credentials</code>: Choose "OAuth Cliend ID", and then "Web application"</li>
<li>Copy "Client ID" and "Client Secret"</li>
</ul></li>
</ul></li>
</ul>
<h3 id="create-a-bucket">2. Create a Bucket</h3>
<ul>
<li>Create bucket which will be used to store your uploaded pdf and generated audio.
<ul>
<li>Go to <a target="_blank" rel="noopener" href="https://console.cloud.google.com/storage">Cloud Storage</a>, click"CREATE BUCKET".</li>
</ul></li>
<li>Configs
<ul>
<li>Location: us-central1 (Be same with the following setting of cloud function, or it could go wrong when you perform AutoML.)</li>
<li>Storage class: "Standard"</li>
<li>Access control: "Fine-grained"! We need to manipulate objects' permissions in this project.</li>
</ul></li>
</ul>
<h3 id="create-a-cloud-funtion">3. Create a Cloud Funtion</h3>
<ul>
<li><p>Go to <a target="_blank" rel="noopener" href="https://console.cloud.google.com/functions">Cloud Function</a>, create a function and config as the following.</p></li>
<li><p>Setting part:</p>
<ul>
<li>Region: us-central1</li>
<li>Trigger type: Cloud Storage</li>
<li>Event type: Finalise/Create</li>
<li>Bucket: my_temp_bucket</li>
<li>Memory &gt; 2GiB (to avoid "out of memory" issues)</li>
<li>Timeout: 540 seconds (It's time-consuming to merge mp3 fragments.)</li>
</ul></li>
<li><p>Codes part:</p>
<ul>
<li>Copy the code of "<a target="_blank" rel="noopener" href="https://github.com/Konfido/pdf2audiobook/blob/master/functions/app/main.py">main.py</a>" and "requirement.txt" to corresponding places.</li>
<li>Runtime: "Python 3.7", Entry point: "p2a_gcs_trigger"</li>
<li>Modify some settings in "main.py" <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ANOTATION_MODE = <span class="literal">True</span></span><br><span class="line">model_display_name = <span class="string">&quot;&quot;</span> 	<span class="comment"># Leave it blank for now</span></span><br></pre></td></tr></table></figure></li>
</ul></li>
</ul>
<h3 id="create-an-apps-script-project">4. Create an Apps Script project</h3>
<ul>
<li><p>Go to <a target="_blank" rel="noopener" href="https://script.google.com/home">Apps Script</a>, create a new project.</p></li>
<li><p>As Kazunori has created such a great <a target="_blank" rel="noopener" href="https://github.com/kazunori279/pdf2audiobook/tree/master/functions/app">notation</a> App, we can use it from the beginning, helping us to finish the initial training dataset labeling.</p></li>
<li><p>I modified Kazunori's code of Cloud Function so that once the Vision API complete the OCR procedure and generate a "xxx-features.csv" file, another function will be triggered to forge a "xxx-labels.csv" file by duplicating "xxx-features.csv" and automatically adding a "label" column to it. By default, any area with more 100 characters in its "text" will be pre-labelled as "body", and all other areas will be pre-labelled as "other".</p></li>
<li><p>Make API request to Google Cloud Storage</p>
<ul>
<li>Kazunori's <a target="_blank" rel="noopener" href="https://github.com/kazunori279/pdf2audiobook/blob/b21ccc1bd6e78a472bb01a353d5aa18c0dd1c405/apps-script/do_get.gs#L77">code</a> skips the credential part, but at the same time, it took me a lot effort into figuring out how to pass the credential, modifying the code and even writing another <a href="https://konfido.github.io/Request-to-Cloud-Storage-API-in-Apps-Script-with-OAuth2/">blog</a> to elaborate on it. I doubt that I missed out something that complicated the whole process. (My assumption is that I only modify and deploy the Script in the web editor, but instead, he set up the environment of credential in shell session and used the command line tool <a target="_blank" rel="noopener" href="https://github.com/google/clasp">clasp</a> to create Script's deployment.) If you've tries the other method or know the right way to do it, please leave a comment below.</li>
<li>From <a target="_blank" rel="noopener" href="https://cloud.google.com/storage/docs/authentication#oauth-flows">what</a> I know, the Cloud Storage uses OAuth2 protocol for API authentication and authorization. The access token can be found in <a target="_blank" rel="noopener" href="https://developers.google.com/oauthplayground/">OAuth Playground</a> which can be directly added to the Kazunori's code. Or you can modify the code, like I did, which will help you simplify the authentication process by providing a clickable "Consent Screen".</li>
<li>If you want to use my <a target="_blank" rel="noopener" href="https://github.com/Konfido/pdf2audiobook/tree/master/apps-script">code</a>, checkout my other <a href="https://konfido.github.io/Request-to-Cloud-Storage-API-in-Apps-Script-with-OAuth2/">blog</a> on setting details. But if you want to use Kazunori's code, it just need a little modification to the "fetch" request in "downloadLabels()" function, which should looks like this: <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Code.gs</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">downloadLabels</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">var</span> resp = UrlFetchApp.fetch(url, &#123;</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">        <span class="attr">headers</span>: &#123;</span><br><span class="line">            <span class="attr">Authorization</span>: <span class="string">&#x27;Bearer &#x27;</span>+ YOUR_TOKEN,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">&#x27;muteHttpExceptions&#x27;</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>And this token will expire in 1h, so remember to refresh it when you encounter some 401 issues.</li>
</ul></li>
</ul>
<h3 id="create-a-spread-sheet">5. Create a Spread Sheet</h3>
<ul>
<li>We need to create a <a target="_blank" rel="noopener" href="https://docs.google.com/spreadsheets">Spread Sheet</a> to store all labelled training data.</li>
<li>Take note of its ID in browser's address bar.</li>
</ul>
<h3 id="label-the-training-dataset">6. Label the training dataset</h3>
<ul>
<li><p>Once you've done the previous step and copied the code into corresponding places, you can select out one PDF file as our first labelling target and upload it to the bucket. It will generate a "xxx-features.csv" file.</p></li>
<li><p>Paste the name and other configs of the file to "Code.gs" in Script. <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> PDF_NAME = <span class="string">&#x27;&lt;YOUR PDF FILE NAME&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> BUCKET_NAME = <span class="string">&#x27;&lt;YOUR BUCKET NAME&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> SHEET_ID = <span class="string">&#x27;&lt;YOUR SHEET ID&gt;&#x27;</span>;</span><br></pre></td></tr></table></figure></p></li>
<li><p>Go the test web app we already created, refresh the webpage. And finally we can see the fabulous labelling webpage. Hooray!</p></li>
<li><p>Click the element with wrong labels on the webpage, loop through four colors until presenting the right one. Note the spreadsheet, on which the corresponding label part will change.</p>
<ul>
<li>Others: gray</li>
<li>Body: Yellow</li>
<li>Header: red</li>
<li>Caption: blue</li>
</ul></li>
<li><p>Once the labelling is done, switch to another PDF file and start labelling again. (There exists one issue, that I don't why the webpage always fails on the first refresh after modifying the PDF_NAME. So remember to refresh the webpage when you encounter some unreasonable problem.)</p></li>
<li><p>After we've labeled all the PDF, copy all Spreed Sheet (tab) into one and download the it as a CSV file.</p></li>
</ul>
<h3 id="create-an-automl-table">7. Create an AutoML Table</h3>
<ul>
<li><p>Go to <a target="_blank" rel="noopener" href="https://console.cloud.google.com/automl-tables/introduction">AutoML Table</a></p>
<ul>
<li>Click <code>NEW DATA SET</code> &gt; <code>Upload files from your computer</code>: select our just downloaded "all_labels.csv" file.</li>
<li>Select "label" as target</li>
<li>Click <code>Train</code>, uncheck "id" in features, train 2h</li>
<li>Model name: "label_predict"</li>
</ul></li>
<li><p>The training will automatically stop once the model start overfitting. (My training dataset has 3500 entries and the training early stops after about 40 minutes.)</p></li>
<li><p>And the evaluate result seems not bad, and now our model can predict the right labels (body, caption, header, other) from the feature files generated by Vision API.</p>
<p><img src="../images/20210508171525893.png" width="90%" /></p></li>
</ul>
<h3 id="select-an-audio-voice">8. Select an audio voice</h3>
<ul>
<li>Go to the page of <a target="_blank" rel="noopener" href="https://cloud.google.com/text-to-speech">Cloud Text-to-Speech</a>
<ul>
<li>Adjust the options to get your preferred voice.</li>
<li>Click <code>Show JSON</code>, note the config values.</li>
</ul></li>
<li>Inspired by <a target="_blank" rel="noopener" href="https://daleonai.com/pdf-to-audiobook">Markowitz</a>, I also modified the Kazunori's code to synthesize different voices for "header", "caption" and "body".</li>
</ul>
<h3 id="edit-the-cloud-function">9. Edit the Cloud Function</h3>
<ul>
<li><p>Go to the <a target="_blank" rel="noopener" href="https://console.cloud.google.com/functions">Cloud Function</a></p>
<ul>
<li>Now we should disable the ANNOTATION_MODE, switching to "Speech Mode".</li>
<li>Add the name of your AutoML (prediction) model and adjust the configuration of your preferred voice. <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ANOTATION_MODE = <span class="literal">False</span></span><br><span class="line">model_display_name = <span class="string">&quot;&lt;you-predict-model&gt;&quot;</span></span><br><span class="line">LANGUAGE_CODE = <span class="string">&quot;en-GB&quot;</span></span><br><span class="line">PITCH = &#123;...&#125;</span><br><span class="line">SPEAKING_RATE = &#123;...&#125;</span><br><span class="line">NAME = &#123;...&#125;</span><br></pre></td></tr></table></figure></li>
</ul></li>
<li><p>Deploy the Function again.</p></li>
</ul>
<h3 id="generate-the-audio">10. Generate the audio</h3>
<ul>
<li><p>Upload a new PDF file to your bucket</p></li>
<li><p>Navigate to "LOGS" tab of the Cloud Function, check out how the process goes, or just wait for a few minutes.</p></li>
<li><p>And finally, enjoy your audio. Hooray!</p></li>
</ul>
<h2 id="deploy-and-debug-with-command-line">Deploy and Debug with command line</h2>
<p>I list some general steps when you deploy and debug functions with command line. Please refer to the <a target="_blank" rel="noopener" href="https://cloud.google.com/vision/docs/setup">document</a> for details.</p>
<ul>
<li><p>Set up the environment</p>
<ul>
<li>Create service account</li>
<li>Create a service account key</li>
<li>Set environment</li>
<li>Download and install Google Cloud SDK</li>
<li>Install Vision Client Libraries</li>
</ul></li>
<li><p>Register a trigger function to Google Cloud Function</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ./<span class="built_in">functions</span>/app</span><br><span class="line">gcloud <span class="built_in">functions</span> deploy p2a_gcs_trigger --runtime python37 --trigger-bucket &lt;bucket&gt; --memory=2048MB --timeout=540</span><br></pre></td></tr></table></figure></p></li>
<li><p>Wait a few minutes till the Cloud Function is running.</p></li>
<li><p><strong>NOTE</strong></p>
<ul>
<li>After you modify the of Cloud Function, the new version of deployment may not update at all! Referring to this <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/65674730/google-cloud-function-doesnt-update-on-change-when-using-deployment-manager">QA</a>, I decide to add an extra parameter "version" in the setting, and deliberately change its value on every deployment.</li>
</ul></li>
</ul>
<h2 id="references">References</h2>
<p>These blogs also helped me a lot finishing this project.</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/advertising/scripts/examples/authenticating-with-google-services">Authenticating with Google services</a></p></li>
<li><p><a target="_blank" rel="noopener" href="http://blog.warehouseman.com/2014/10/getting-started-with-google-cloud.html">Getting started with Google Cloud Datastore for Google Apps Script</a></p></li>
<li><p><a target="_blank" rel="noopener" href="https://www.labnol.org/code/20074-upload-files-to-google-cloud-storage">Upload Files to Google Cloud Storage with Google Scripts</a></p></li>
</ul>

  </div>
</article>

  <div class="reward-container">
  <div>Consider buying me a drink if you like this post.</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    Donate
  </button>
  <div id="qr" style="display: none;">
    
      
      
        
      
    <div style="display: inline-block;">
      <img src="/images/wechatpay.png">
      <p>WeChat Pay</p>
    </div>
    
      
      
        
      
    <div style="display: inline-block;">
      <img src="/images/alipay.png">
      <p>Alipay</p>
    </div>
    
      
      
        
      
    <div style="display: inline-block;">
      <img src="/images/paypal.png">
      <p>PayPal</p>
    </div>
    
      
      
        
      
    <div style="display: inline-block;">
      <img src="/images/coffee.png">
      <p>Buy Me a Coffee</p>
    </div>
    
  </div>
</div>



    
        <div class="blog-post-comments">
            <div id="vcomments"></div>
        </div>
    



<script src="//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js"></script>
<script>
    new Waline({
        el: '#vcomments',
        serverURL: 'https://waline-comments.vercel.app/',
        placeholder: 'Support for anonymous comments.',
        wordLimit: '350',
        avatar: 'mp',
        pageSize: '10',
        lang: 'en',
        visitor: 'true',
        dark: 'auto',
        requiredMeta: 'name'
        });
</script>
        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#what-why"><span class="toc-number">1.</span> <span class="toc-text">What &amp; Why?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#what-google-servicesapis-are-we-gonna-use"><span class="toc-number">2.</span> <span class="toc-text">What Google services&#x2F;APIs are we gonna use?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#what-can-we-finally-achieve"><span class="toc-number">3.</span> <span class="toc-text">What can we finally achieve?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#how-to-evaluate-the-final-result"><span class="toc-number">4.</span> <span class="toc-text">How to evaluate the final result?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-by-step-guide"><span class="toc-number">5.</span> <span class="toc-text">Step-by-step guide</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#create-a-google-cloud-project"><span class="toc-number">5.1.</span> <span class="toc-text">1. Create a Google Cloud project</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#create-a-bucket"><span class="toc-number">5.2.</span> <span class="toc-text">2. Create a Bucket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#create-a-cloud-funtion"><span class="toc-number">5.3.</span> <span class="toc-text">3. Create a Cloud Funtion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#create-an-apps-script-project"><span class="toc-number">5.4.</span> <span class="toc-text">4. Create an Apps Script project</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#create-a-spread-sheet"><span class="toc-number">5.5.</span> <span class="toc-text">5. Create a Spread Sheet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#label-the-training-dataset"><span class="toc-number">5.6.</span> <span class="toc-text">6. Label the training dataset</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#create-an-automl-table"><span class="toc-number">5.7.</span> <span class="toc-text">7. Create an AutoML Table</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#select-an-audio-voice"><span class="toc-number">5.8.</span> <span class="toc-text">8. Select an audio voice</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#edit-the-cloud-function"><span class="toc-number">5.9.</span> <span class="toc-text">9. Edit the Cloud Function</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#generate-the-audio"><span class="toc-number">5.10.</span> <span class="toc-text">10. Generate the audio</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#deploy-and-debug-with-command-line"><span class="toc-number">6.</span> <span class="toc-text">Deploy and Debug with command line</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#references"><span class="toc-number">7.</span> <span class="toc-text">References</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&text=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&title=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&is_video=false&description=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning&body=Check out this article: https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&title=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&title=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&title=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&title=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&name=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://konfido.github.io/Convert-PDFs-to-Audiobooks-with-Machine-Learning/&t=PDF2Audio - Convert PDFs to Audiobooks with Machine Learning"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2017-2021
    Konfido
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-120506290-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-120506290-1');
    </script>

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?402f987e4873e1ee456b67464a20826f";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
